# Hive to Isar Migration Notes

## Overview
This PR migrates the local database from Hive to Isar as recommended by the Hive maintainers.

## Changes Made

### Dependencies (pubspec.yaml)
- **Removed:**
  - `hive: ^2.2.3`
  - `hive_flutter: ^1.1.0`
  - `hive_generator: ^2.0.1`
  - `dio_cache_interceptor_hive_store: ^3.2.2`

- **Added:**
  - `isar: ^3.1.0+1`
  - `isar_flutter_libs: ^3.1.0+1`
  - `isar_generator: ^3.1.0+1`
  - `dio_cache_interceptor_file_store: ^1.2.0`

### Model Changes
- **LinkMetadata** (`lib/models/link_metadata.dart`): Converted from Hive model to Isar collection with unique URL index

### New Isar Collections
Created Isar collection models for local data storage:
- **SettingsData**: Stores user settings (previously stored in Hive box)
- **VersionData**: Stores version check information
- **AppReviewData**: Stores app review tracking metrics
- **PlanData**: Stores plan-related local data

### Service Updates
- **StorageService**: Added `getIsar()` method to manage the single Isar instance
- **SettingsService**: Refactored to use Isar collections instead of Hive boxes
- **LinkMetadataService**: Updated to query Isar collections with URL filters
- **VersionService**: Converted to use Isar for data persistence
- **AppReviewService**: Migrated to Isar collections
- **PlanService**: Updated local storage to use Isar

### Initialization Changes (`lib/main.dart`)
- Replaced `initializeHive()` with `initializeIsar()`
- Removed Hive adapter registration
- Removed old Hive box cleanup code

## Code Generation

The migration requires running build_runner to generate Isar schema files:

```bash
flutter pub get
flutter pub run build_runner build --delete-conflicting-outputs
```

The CI workflow (`.github/workflows/analyze.yml`) already includes this step, so generated files will be created automatically during the build process.

## Generated Files

The following files will be generated by `build_runner`:
- `lib/models/link_metadata.g.dart` - Isar schema for LinkMetadata
- Isar schemas for all collection models in services

Note: Generated `.g.dart` files are not committed to the repository and will be created during the build process.

## Key Differences: Hive vs. Isar

### Data Storage
- **Hive**: Used key-value box storage with adapters
- **Isar**: Uses collections with query builders and indexes

### Querying
- **Hive**: Direct key-based access: `box.get(key)`
- **Isar**: Query builders: `isar.collection.filter().property().findFirst()`

### Watching Changes
- **Hive**: Box-level or key-level watches: `box.watch(key: 'key')`
- **Isar**: Collection-level watches: `isar.collection.watchLazy()`

### Transactions
- **Hive**: Implicit transactions with each `put()`
- **Isar**: Explicit write transactions: `isar.writeTxn(() async { ... })`

## Data Migration

**Important**: This migration does not include automatic data migration from Hive to Isar. Users will:
- Lose cached link metadata (will be re-fetched as needed)
- Need to reconfigure any custom settings
- Lose app review tracking progress

These are acceptable losses as the data is either transient (cache) or will be rebuilt through normal app usage (settings, review tracking).

## Testing

After the migration:
1. Settings should persist across app restarts
2. Link metadata should be cached and retrieved correctly
3. App review tracking should function as before
4. Version checking should work correctly

## Rollback Plan

If issues arise, the migration can be rolled back by:
1. Reverting the PR
2. Running `flutter pub get` to restore Hive dependencies
3. Running `flutter pub run build_runner build --delete-conflicting-outputs`
